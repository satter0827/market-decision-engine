# パイプライン設計書（EOD Pipeline Spec）

## market-decision-engine

## 0. 目的と範囲

本書は、EOD（日次・市場別）バッチにおける **処理順序（Step）**、**各Stepの責務境界**、**失敗時の縮退**、**実行コンテキスト**を定義する。
アルゴリズムの詳細やデータ型はコード（Pydantic/テスト）で担保するため、本書では扱わない。

---

## 1. パイプラインの前提

### 1.1 実行単位

* 実行は **市場別（JP / US）** に分離する。
* 1回の実行は `market + asof + policy_snapshot` を単位とする。
* 同一入力（market/asof/policy/universe）に対して **同一出力**を原則とする（決定論）。

### 1.2 入力の種類

* **運用方針（UserPolicy）**：閾値・制約・運用設定（実行前に確定）
* **Universe**：対象銘柄集合（実行前に確定）
* **Market Data**：yfinance由来の日足データ（asof基準）
* **（任意）Account State**：資金等（サイズ計算がある場合）

### 1.3 出力の種類

* **Decision Pack**：銘柄ごとの最終成果物

  * DecisionCore（機械可読、発注可能）
  * ShortSummary（任意、LLMで生成・監査）

---

## 2. 実行コンテキスト（Run Context）

パイプライン内の全Stepが共有する「実行コンテキスト」を定義する（※型そのものはコードで担保）。

### 2.1 最低限含めるべきコンテキスト

* `run_id`：一意な実行ID（ログ相関用）
* `market`：JP/US
* `asof`：EOD基準日
* `policy_snapshot_id`：運用方針の識別子
* `universe_id`：Universe識別子（固定ファイルや生成条件のハッシュ等）
* `created_at`：実行開始時刻（監査用）
* `mode`：production / dry-run 等（将来拡張）

### 2.2 コンテキスト設計の意図

* 「いつ・何の条件で・何を出したか」を追跡可能にする。
* 同一条件の再実行を検証可能にする（再現性）。

---

## 3. 全体フロー（高レベル）

1. UserPolicy を読み込み・確定（validation済み）
2. Universe を確定
3. データ取得（市場指標＋各銘柄）
4. 特徴量生成（daily/static/fundamental を分離）
5. 市場環境（regime）判定
6. 候補抽出（dailyのみ）
7. プラン列挙（plan_args）
8. 実行値生成（entry/stop/target/size 等：決定論）
9. リスク・サイズ補正（static・regimeで安全側補正、価格は変えない）
10. ML評価（任意、縮退可能）
11. 最良プラン選択（optimizer）
12. 最終判断確定（YES/YES_HALF/NO + rank）
13. 短文生成（LLM：翻訳・監査のみ、失敗時は省略）
14. 出力整形（JSON/Markdown/通知パッケージ）
15. 終了（サマリログ）

---

## 4. Step仕様（責務境界と縮退）

各Stepは「入力→出力」を持ち、失敗は **銘柄単位の局所化**を原則とする。
ただし、**入力契約違反（設定不備）**など全体に影響するものは市場単位で停止する。

### 4.1 Step一覧（外部から見える責務）

| Step | 名称               | 主責務                            | 失敗時の扱い（縮退方針）                   |
| ---- | ---------------- | ------------------------------ | ------------------------------ |
| S00  | Run Setup        | run_context確立、ログ初期化            | 致命：停止                          |
| S01  | Policy Load      | UserPolicy確定（validation済み）     | 致命：停止                          |
| S02  | Universe Resolve | Universe確定                     | 致命：停止（空なら停止推奨）                 |
| S03  | Market Data Load | 市場指標データ取得                      | 保守：regimeをneutral/defensiveに固定 |
| S04  | Ticker Data Load | 銘柄別OHLCV取得                     | 銘柄スキップ＋warnings                |
| S05  | Feature Build    | daily/static/fundamental生成     | daily不成立は銘柄スキップ                |
| S06  | Regime Detect    | market_env判定                   | 保守：defensive/neutral           |
| S07  | Candidate Select | 候補抽出（dailyのみ）                  | 候補ゼロ：空で終了（当日NO相当）              |
| S08  | Plan Enumerate   | plan_args列挙                    | 既定プランへフォールバック                  |
| S09  | Execute Plan     | entry/stop/target/size計算       | plan除外（reject_reason付与）        |
| S10  | Risk Adjust      | サイズ/可否補正（価格不変）                 | 補正なし＋warnings（安全側）             |
| S11  | ML Evaluate      | p_success/ev/uncertainty推定（任意） | degradedフラグ＋保守化                |
| S12  | Optimize         | best_plan選択                    | bestなし：NOに倒す                   |
| S13  | Compose Decision | DecisionCore確定、rank付与          | NOに倒す                          |
| S14  | Summarize        | ShortSummary生成（LLM）            | summary省略 or テンプレ              |
| S15  | Report/Export    | 出力整形・配信パッケージ                   | coreは必ず出す（可能な範囲で）              |
| S16  | Run Finalize     | 終了サマリ、統計（件数等）                  | 失敗しても終端ログは残す                   |

---

## 5. 重要な責務境界（ブレを防ぐための規定）

### 5.1 候補抽出（S07）の根拠は daily のみ

* 候補抽出は「価格の振る舞い」を根拠とする。
  static/fundamental を混ぜると、検証困難・恣意性が増すため、候補抽出には入れない。

### 5.2 実行値生成（S09）は daily のみで完結

* entry/stop/target などの **価格に関する決定**は daily のみ。
* 理由：説明可能性と検証可能性（何が根拠で価格を決めたか）を維持するため。

### 5.3 リスク補正（S10）は「価格を変えずに可否・サイズのみ」

* static/regime は「事故率低減」のために使う。
* 価格を動かし始めると原因切り分けが困難になるため、補正はサイズ・可否に限定する。

### 5.4 ML（S11）は任意であり、縮退可能でなければならない

* MLが落ちてもパイプラインは成立する（DecisionCoreを出す）。
* MLは判断を“強める”よりも、**不確実性を理由に保守化**する用途を優先する。

### 5.5 LLM（S14）は翻訳器であり、DecisionCoreに介入しない

* LLM不調時は ShortSummary を省略してもよい。
* DecisionCore の出力継続が最優先（運用の安全性）。

---

## 6. エラーモデル（停止 vs スキップ）

本パイプラインの失敗は次の2種に分類する。

### 6.1 市場停止（Fatal）

* UserPolicyの検証失敗
* Universeが確定できない／空集合（運用ポリシーによるが停止推奨）
* パイプラインの契約破壊（出力生成不能など）

### 6.2 銘柄スキップ（Non-fatal）

* yfinanceデータ取得不能
* 日足が欠損・不足
* Feature生成不能
* すべてのplanがrejectされた

**原則**：不明・曖昧・例外は「より局所」へ押し込み、最終的に **NO**（安全側）に倒す。

---

## 7. 決定論（再現性）の扱い

「同一入力→同一出力」を守るために、パイプラインとして次を要求する。

* `asof` を明示入力として扱い、内部で「今日」を参照しない（参照するならrun_contextに固定化する）
* 乱数を使う場合は seed をrun_contextで固定する
* LLM出力は ShortSummary に限定し、coreの数値に影響させない
* 外部I/O（yfinance）の揺れは避けられないため、可能なら同一runでキャッシュを持つ（※永続化の可否は要件に従う）

---

## 8. 出力と配信（最小要件）

* 最低限、**DecisionCore を含む Decision Pack**を出力できること。
* ShortSummary は任意（あれば付与、なければ省略）。
* 出力形式は実装規約に従うが、パイプラインとしては「整形・配信は最後段（S15）」に閉じ込める。

---

## 9. M1（最小実装）における必須Step

M1として成立させる最小構成は次の通り。

* S00〜S07（候補抽出まで）
* S08〜S10（実行値生成と補正）
* S12〜S13（最終判断と出力生成）
* S15〜S16（出力と終了）

LLM（S14）と ML（S11）は **M1では省略可能**とする（ただし、追加してもパイプラインが崩れない構造にする）。

---

## 10. 受け入れ観点（パイプライン設計として）

パイプライン設計の受け入れは、以下を満たすこと。

* 市場別（JP/US）に独立実行できる
* 欠損や取得失敗があっても全体が落ちない（銘柄スキップ）
* 同一入力条件で同一出力（少なくともcore）が得られる
* LLM/MLが無くてもDecisionCoreが出る（縮退が成立）
