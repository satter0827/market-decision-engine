# 外部設計書: market-decision-engine

## 1. 目的・位置づけ

本システムは、**yfinance から取得可能な日足OHLCV等**を用いて、**市場終了後（EOD）**に銘柄ごとの投資判断支援情報（Decision Pack）を自動生成し、利用者（人間）が最終判断して発注するための支援を行う。

**重要原則（外部設計の制約）**

* 判断の主体は **数値（DecisionCore）**。短文は補助であり、判断基準を増やさない。
* LLMは **数値生成・判断介入を禁止**し、説明（翻訳）とフォーマット監査に限定する。
* 同一入力→同一出力を原則（AI層内部は非循環）。改善は運用の外側（週次/月次）。

---

## 2. 対象範囲（スコープ）

### 2.1 対象市場・実行単位

* 対象市場：**JP / US**
* 実行：**市場別EODバッチ**（日次）

### 2.2 データソース・分析粒度

* データ：**yfinance（取得可能データは収集対象）**
* 分析：**日足ベース（EOD）**

### 2.3 非スコープ（本外部設計で扱わないこと）

* LLMがEntry/Stop/Size等の数値を生成すること
* LLMが売買シグナルを独自に変えること
* ティック/分足など高頻度前提
* ニュース/SNS/板等の外部データ（初期）
* 発注API連携（最終判断は人間、発注は別系）

---

## 3. 外部インタフェース一覧

| 区分 | 名称             | 形式             | 目的                 |
| -- | -------------- | -------------- | ------------------ |
| 入力 | UserPolicy     | JSON（Schema検証） | 運用方針・閾値・制約の固定化     |
| 出力 | Decision Pack  | JSON（機械可読＋短文）  | 発注可能値＋信用度＋短文要約     |
| 配信 | Email Packager | メール（実装方式は別途）   | 日次EODの結果通知（JP/US別） |

※メール配信は運用要件として明示されているが、外部設計上は「Decision Packを配信するチャネル」の一つとして扱う。

---

## 4. 入力仕様（UserPolicy）

### 4.1 目的

ユーザーの運用方針を構造化し、運用を**再現可能**にする。

### 4.2 主な入力項目（外部から観測される要件）

* 市場（JP/US）、保有期間レンジ
* リスク（1トレード損失%、最大DD%）
* 制約（同時保有数、テーマ集中上限）
* 判断閾値（min_success_prob、min_expected_r、max_uncertainty）
* 実行設定（YES_HALFの扱い、利確方式、タイムストップ）
* レポート設定（言語、短文化）
* 任意：意思ログ短文（方針宣言1〜2文）

### 4.3 処理（外部仕様としての約束）

* JSON Schema検証
* デフォルト補完
* **policy_snapshot_id** 発行（方針バージョン識別）

### 4.4 ルール

* UserPolicyを日次で頻繁に変更しない（検証不能になるため）
* 変更時はpolicy_snapshot_idを更新

### 4.5 失敗時

* バリデーションエラーとして扱い、**日次処理を停止**（推奨）

---

## 5. 出力仕様（Decision Pack）

Decision Packは「機械可読（DecisionCore）」と「人間可読（ShortSummary）」から構成される。

### 5.1 DecisionCore（機械可読：発注可能）

**目的**：採用すればそのまま発注可能な具体値を提供する。

**入力**：best_plan（Execution + ML評価）、UserPolicy（制約）

**処理**（外部から見える責務）

* BUY判定（YES/YES_HALF/NO）
* 発注値確定（Entry/Stop/Target/Size）
* リスク値確定（MaxLoss/TimeStop）
* ランク付け

**最低限の出力項目**

* ticker
* buy_signal（YES/YES_HALF/NO）
* entry / stop / target_2r / target_3r
* position_size / max_loss / time_stop_days
* p_success / ev_r / uncertainty / plan_score / rank
* plan_args
* policy_snapshot_id

**ルール**

* LLMはDecisionCoreを改変しない
* BUY語彙は3値固定

**失敗時**

* 原則 **NOに倒す（安全側）**

---

### 5.2 ShortSummary（人間可読：短文）

**目的**：数字の解釈を短時間で行えるよう根拠とリスクを短文化する。

**入力**：decision_core、key_features（少数）、market_env、UserPolicy（閾値・レポート設定）

**出力項目**

* headline (総評, 判断は行わず、その前提を言語化する)
* profile（固定語彙1行）
* strength（1文）
* risk（1文）
* if_then（任意、1文）
* warnings（任意、最大3）

**ルール**

* 最大3文＋If-Then 1文
* 新しい判断基準を追加しない
* 数値生成禁止

**失敗時**

* 定型テンプレにフォールバック

---

## 6. システム処理フロー（EODバッチ外部仕様）

### 6.1 高レベルフロー（入力→出力）

UserPolicy(JSON) → Universe Provider → Data Loader(yfinance) → Feature Generator → Market Regime Detector → Candidate Selector → Plan Factory → Execution Tool → Risk/Sizing Adjuster → ML Evaluator → Plan Optimizer → Decision Composer → AI Layer → Decision Pack

### 6.2 バッチ実行（運用観点）

* JP市場：EOD後に実行→メール配信
* US市場：EOD後に実行→メール配信
* 上位N銘柄をランキングして提示

---

## 7. 機能分割（外部境界としてのモジュール責務）

本章は「内部設計」ではなく、外部設計として **“何がどこまで責任を持つか（入力/出力/失敗時）”** を定義する。

### 7.1 Universe Provider

* 入力：market（JP/US）、UserPolicy（除外条件）
* 出力：tickers[]
* ルール：Universeは日次で激しく変えない（検証性）
* 失敗：空なら停止

### 7.2 Data Loader（yfinance）

* 入力：tickers[]、lookback_days（例：400〜600営業日）
* 出力：ohlcv[ticker]
* ルール：欠損が多い銘柄は除外、キャッシュで再実行高速化
* 失敗：銘柄単位でスキップ＋warnings

### 7.3 Feature Generator（daily/static/fundamental）

* 入力：ohlcv[ticker]、yfinance追加データ（可能なら）
* 出力：features_daily/static/fundamental
* ルール：未来情報混入禁止（リーク防止）、欠損時はグループ単位で無効化しwarnings

#### Feature Group 分割（混ぜるな危険）

* daily：候補抽出・実行値生成の主役。Candidate SelectorとExecution Toolはdaily以外を参照しない。
* static：事故率低減（流動性・集中等）。Entry/Stop/Targetの計算には混ぜず、Risk/Sizingでのみ使用。
* fundamental：ML評価拡張。asof_date不明は原則投入しない（リーク防止）。段階導入。

### 7.4 Market Regime Detector

* 入力：index_ohlcv、UserPolicy（リスクオフ時方針）
* 出力：market_env（regime等）
* 失敗：保守的にOFF

### 7.5 Candidate Selector

* 入力：features_daily、market_env、UserPolicy（フィルタ）
* 出力：candidates[]
* ルール：Candidate抽出はdailyのみ参照
* 失敗：候補ゼロなら当日はNOのみ配信

### 7.6 Plan Factory

* 入力：PlanCatalog、UserPolicy.execution_preference
* 出力：plan_args_set[]
* ルール：引数候補はカタログで管理（検証可能化）
* 失敗：既定1セットにフォールバック

### 7.7 Execution Tool（ヒューリスティック）

* 入力：features_daily、account_state、plan_args
* 出力：execution_result（entry/stop/targets/size/max_loss/time_stop + rule_passed）
* ルール：Executionはdailyのみ参照、R極小なら除外
* 失敗：rule_passed=false + reject_reason

### 7.8 Risk/Sizing Adjuster（補正）

* 入力：execution_result、features_static、market_env、UserPolicy
* 出力：adjusted_execution_result（size調整・eligibility）
* ルール：Entry/Stop/Targetは変更しない（サイズと可否のみ）
* 失敗：補正なし（modifier=1.0）＋warnings

### 7.9 ML Evaluator

* 入力：features_daily（必須）、static/fundamental（任意、段階導入）、plan_args、adjusted_execution_result
* 出力：ml_eval（p_success/ev_r/uncertainty + health_flags）
* ルール：ML不調時は保守運用に縮退
* 失敗：ml_degradedフラグ＋意思決定を保守化

### 7.10 Plan Optimizer

* 入力：adjusted_execution_result[]、ml_eval[]、UserPolicy
* 出力：best_plan
* ルール：不確実性に常にペナルティ
* 失敗：NOに倒す

### 7.11 Decision Composer

* 入力：best_plan、UserPolicy（閾値）、PortfolioPolicy（同時保有・集中）
* 出力：decision_core
* ルール：BUY語彙3値固定、不明時はNO
* 失敗：NOに倒す

### 7.12 AI Layer（短文要約・フォーマット監査）

* 入力：decision_core、key_features、market_env、UserPolicy.report_preference
* 処理：Contract Validator→Strategy Labeler→Evidence/Risk/If-Then→Writer→Linter（内部一方向）
* 出力：short_summary、warnings
* ルール：数値生成禁止・判断基準追加禁止・固定語彙のみ・違反時テンプレ強制
* 失敗：short_summary最小テンプレ、decision_core保持

---

## 8. フェイルセーフ（外部観測できる縮退仕様）

* **LLM障害**：DecisionCoreのみ配信（short_summaryなし）
* **ML不調**：YESをYES_HALF/NOに寄せる（保守運用）
* **データ欠損**：当該銘柄除外＋warnings
* **フォーマット違反**：Linterで強制修正

---

## 9. 最小実装（MVP）における外部仕様の確定範囲

MVPで最低限提供する外部機能（＝外部設計上の“必達”）：

* Universe Provider
* Data Loader（yfinance）
* Feature Generator（daily最小）
* Market Regime Detector
* Candidate Selector
* Execution Tool（1戦略、少数引数）
* Risk/Sizing Adjuster（static最小）
* ML Evaluator（p_successのみでも可）
* Decision Composer
* AI Reporter（短文3文＋Linter）
* Email Packager

---

## 10. 外部設計としての「過不足」チェック結果

### 足りている（本再作成により外部設計として成立）

* 入出力契約（UserPolicy / Decision Pack）
* EODパイプラインと責務境界
* 失敗時の縮退（LLM/ML/欠損）
* 運用スケジュール（日次・週次/月次）

### 追加で“文書として”明確化するとさらに堅い（ただし、外部設計の必須要件ではない）

外部設計を「完全に機械的に実装へ落とす」観点で、次の2点が別紙（付録）であると実装が安定します。

* DecisionCoreの**単位・丸め・許容範囲**（例：JPY/USD、株数単位、価格小数桁、rankの同順位処理）
* warnings/profile等の**固定語彙リスト**（vocabulary.jsonに委譲する前提は既に記載あり）

---