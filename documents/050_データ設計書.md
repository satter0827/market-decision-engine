# データ設計書（Data Contract / Data Quality Rules）

## market-decision-engine

## 0. 目的と範囲

本書は、EOD パイプラインが使用するデータについて、**取得前提・基準日時（asof）・時間帯（TZ）・品質判定・欠損時の扱い**を最小限の言語で固定する。
スキーマ（型）やバリデーション手順そのものはコード（Pydantic/テスト）で担保する。

---

## 1. データの分類（扱いの違いを固定）

本システムが扱うデータは、以下の3種に分類する。分類ごとに「品質要件」と「失敗時の縮退」が異なるため、分類は設計上の前提とする。

1. **市場データ（Market-level）**
   例：指数（TOPIX、S&P500等）、VIX相当、為替（必要なら）
   用途：regime 判定、保守化の判断
2. **銘柄データ（Ticker-level）**
   例：日足OHLCV（adjusted含む）
   用途：daily feature、候補抽出、execution の根拠
3. **補助データ（Auxiliary）**
   例：銘柄メタ情報、static（時価総額、出来高平均など）、fundamental（財務）
   用途：risk/sizing の補正、ML評価（段階導入）

---

## 2. 基準日時（asof）と時間帯（TZ）

### 2.1 asof の定義

* `asof` は **「当該市場における EOD（終値確定）を基準とする取引日」**を指す。
* パイプラインは `asof` を明示入力として受け取り、内部で “今日” を参照しない。

### 2.2 タイムゾーン

* `market=JP` は Asia/Tokyo を基準とする。
* `market=US` は米国市場（通常 ET）を基準とするが、内部の保存・比較は **日付（取引日）単位**を最優先に扱う。

### 2.3 設計意図（最小の言語化）

* EOD 実行はタイムゾーン境界の影響を受けやすく、`asof` が曖昧だと再現性が壊れる。
  よって、内部のすべての判断は `asof` に紐づく「取引日基準」で統一する。

---

## 3. データソースと優先順位

### 3.1 一次ソース

* 一次ソースは **yfinance** とする（M1〜）。

### 3.2 再現性に関する注意（コード化しにくい点）

* yfinance は取得タイミング・バックエンド事情により揺れる可能性がある。
  そのため本システムは、**“完全な外部再現性（他環境で常に一致）” ではなく、“同一実行条件での内部再現性”**を第一義とする。
* 可能なら同一 run 内でキャッシュ（メモリ/ローカル一時）を用い、同一 run での再取得差分を減らす。
  ※永続化方針が「対象外」でも、**実行中キャッシュ**は許容される前提でよい。

---

## 4. データ粒度・必須範囲（最小要件）

### 4.1 必須粒度

* 初期は **日足（1D）**のみを対象とする。

### 4.2 lookback（履歴長）

* lookback は「daily feature と execution が必要とする最小期間」を満たすこと。
  具体日数はコード側の既定値でよいが、設計としては以下を要求する：

  * **最低でも数百営業日**（トレンド/ボラ/ATR系の安定計算のため）
  * 不足する銘柄は **銘柄スキップ**の対象とする

---

## 5. 企業アクション（分割・配当等）の扱い

### 5.1 原則

* 価格系列（OHLC）は、**同一系列内で一貫した定義**で扱う。
  （adjusted を使うなら adjusted で統一、そうでなければ raw で統一）

### 5.2 最低限の要件（言語化）

* adjusted / raw の選択は **プロジェクトとして固定**する（途中で混ぜない）。
* 企業アクション由来の不連続が疑われる場合は、銘柄に warnings を付与できる設計とする（※判定ロジックはコード）。

---

## 6. データ品質ルール（Data Quality Rules）

ここはコードで検証できるが、**何を“品質不良”とみなすかの合意**だけを言語化する。

### 6.1 銘柄データ（OHLCV）の最低品質

銘柄データが以下のいずれかに該当する場合、原則 **銘柄スキップ**とする。

* `asof` までの時系列が連続していない（大きな欠落がある）
* `asof` 近傍の終値が欠損
* 出来高が継続的に欠損または実質ゼロ（流動性判断不能）
* 必要な lookback 長を満たさない

### 6.2 市場データの最低品質

市場データが不成立の場合は、**regime を保守（neutral/defensive）に固定**して継続する（市場停止はしない）。
理由：市場データは補助であり、銘柄の Execution を直接決める主根拠ではないため。

### 6.3 補助データ（static/fundamental）

* static が不成立：risk/sizing の補正を弱める（補正なし or 最小補正）＋warnings
* fundamental が不成立：fundamental を使う評価を無効化し、ML を縮退させる＋warnings
  （fundamental は段階導入であり必須ではない）

---

## 7. 欠損・異常値の扱い（縮退の方針）

### 7.1 方針

* 欠損は「埋めて精度を上げる」よりも、**除外・縮退で安全側に倒す**。
* 欠損の扱いは feature の種類で異なる：

  * daily：欠損が致命 → 候補抽出・execution不可 → 銘柄スキップ
  * static：欠損 → 補正弱化（サイズを増やさない）＋warnings
  * fundamental：欠損 → ML縮退＋warnings

### 7.2 設計意図

* 欠損補完は「見かけの安定」を生むが、検証不能になりやすい。
  本システムの価値は **発注可能な数値を再現可能に出すこと**なので、欠損は安全側で扱う。

---

## 8. データ識別子（監査・再現のための最小メタ）

再現性と監査のために、データそのものを永続化しなくても、少なくとも以下を run に紐づけて残せる設計とする。

* `data_source`：yfinance
* `asof`
* `lookback`（取得範囲）
* `universe_id`（銘柄集合の識別）
* `policy_snapshot_id`
* 取得失敗・スキップ件数（統計）

※「どのデータで作ったか」を追跡できる最小情報であり、ログまたは run サマリとして残す。

---

## 9. 非目標（明示）

* データの完全再現（外部環境でも常に同一）は初期では目標としない
  （yfinanceの揺れがあるため）
* ニュース・SNS等の外部情報統合は対象外（初期）
* 分足・ティックは対象外（初期）

---

## 10. この設計書が守るべきこと（最小まとめ）

* `asof` を中心に「取引日基準」で統一する
* daily を主根拠として欠損に厳格、static/fundamental は補助として縮退可能に
* 企業アクションの扱い（adjusted/raw）を混ぜない
* 欠損は補完より安全側縮退
* run の監査メタ（source/asof/lookback/universe/policy）を必ず残す
