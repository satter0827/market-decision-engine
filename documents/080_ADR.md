# Architecture Decision Records（ADR）

## market-decision-engine

---

## ADR-001：EOD・日次バッチを採用する

**Status**：Accepted
**Context**：
高頻度やリアルタイムに対応すると、再現性・監査性・運用安定性が著しく低下する。
本システムの目的は「発注可能な数値を、説明可能に提示する」ことであり、即時性は最優先ではない。

**Decision**：

* 処理単位を **市場別 EOD（日次）バッチ**に固定する。

**Consequences**：

* 再現性と検証性が高まる
* 分足・リアルタイムは初期スコープ外

---

## ADR-002：One-way Pipeline（非循環）を採用する

**Status**：Accepted
**Context**：
自己更新・循環構造は、日次実行の再現性と障害切り分けを困難にする。

**Decision**：

* パイプラインは **一方向のみ**
* 学習・改善は日次実行の外側（週次/月次）

**Consequences**：

* 同一入力→同一出力が成立
* オンライン学習は不可（意図的制限）

---

## ADR-003：DecisionCore と ShortSummary を分離する

**Status**：Accepted
**Context**：
自然言語と数値判断を混ぜると、責任境界が崩れ、監査不能になる。

**Decision**：

* 発注可能な判断は **DecisionCore（機械可読）**に限定
* ShortSummary は補助説明に限定

**Consequences**：

* LLM障害でも Core は維持できる
* 人間の最終判断がしやすい

---

## ADR-004：LLMは翻訳器としてのみ使用する

**Status**：Accepted
**Context**：
LLMに数値生成・判断介入を許すと、非決定論性と責任不在が発生する。

**Decision**：

* LLMは **翻訳・要約・監査専用**
* DecisionCore への介入は禁止

**Consequences**：

* LLM不調時の縮退が容易
* 判断品質は決定論ロジックに依存

---

## ADR-005：daily / static / fundamental を厳密に分離する

**Status**：Accepted
**Context**：
特徴量を混在させると、リーク・説明不能・恣意的最適化が起きやすい。

**Decision**：

* daily：候補抽出・価格決定の主根拠
* static：サイズ・可否補正のみ
* fundamental：ML評価のみ（段階導入）

**Consequences**：

* 説明可能性が高い
* 短期的な精度最大化は犠牲

---

## ADR-006：候補抽出は daily のみで行う

**Status**：Accepted
**Context**：
候補抽出に多様な要因を入れると、検証・説明が困難になる。

**Decision**：

* Candidate Selection は daily feature のみ使用

**Consequences**：

* 候補理由が明確
* 一部の好機会は見逃す可能性

---

## ADR-007：Execution（価格決定）と Risk（補正）を分離する

**Status**：Accepted
**Context**：
価格決定とリスク補正を混ぜると、何が効いたのか分からなくなる。

**Decision**：

* Execution：Entry/Stop/Target を決定
* Risk：価格を変えず、サイズ・可否のみ調整

**Consequences**：

* 原因切り分けが容易
* 複雑な最適化は不可

---

## ADR-008：MLは必須とせず、常に縮退可能にする

**Status**：Accepted
**Context**：
MLは価値を高めるが、依存すると運用が壊れる。

**Decision**：

* MLは補助評価
* ML不調時は保守化して継続

**Consequences**：

* 安定運用
* MLなし時の性能上限は低い

---

## ADR-009：Fail-safe は「NOに倒す」を原則とする

**Status**：Accepted
**Context**：
誤った YES は損失を生むが、NO は機会損失で済む。

**Decision**：

* 不明・矛盾・不確実は **NO / YES_HALF** に倒す

**Consequences**：

* 過度な取引を防止
* 攻撃的な戦略は不向き

---

## ADR-010：銘柄スキップを許容し、市場停止は限定する

**Status**：Accepted
**Context**：
データ欠損は日常的に発生する。

**Decision**：

* 銘柄単位の失敗はスキップ
* 入力契約違反のみ市場停止

**Consequences**：

* 運用継続性が高い
* 全銘柄評価は保証されない

---

## ADR-011：yfinance を一次データソースとする

**Status**：Accepted
**Context**：
初期段階で高価・複雑なデータ基盤は不要。

**Decision**：

* 一次ソースを yfinance に固定（M1）

**Consequences**：

* 取得揺れのリスク
* 同一run内再現性を重視

---

## ADR-012：完全な外部再現性より内部再現性を優先する

**Status**：Accepted
**Context**：
外部API依存下で完全再現は現実的でない。

**Decision**：

* 同一 run 条件での再現性を最優先

**Consequences**：

* 環境差分の完全一致は非保証
* 監査メタが重要になる

---

## ADR-013：永続化は必須要件に含めない

**Status**：Accepted
**Context**：
初期段階ではシンプルさを優先。

**Decision**：

* DB・永続ストレージは必須としない
* run 中の一時キャッシュは許容

**Consequences**：

* 実装が軽量
* 長期分析は別系で対応

---

## ADR-014：Buy Signal を 3値（YES / YES_HALF / NO）に固定する

**Status**：Accepted
**Context**：
多値判断は運用を複雑化し、行動が曖昧になる。

**Decision**：

* Buy Signal は 3値固定

**Consequences**：

* 人間が即判断できる
* 細かなニュアンスは Summary に委譲

---

## ADR-015：設計判断は ADR に集約する

**Status**：Accepted
**Context**：
コードと設計意図の乖離を防ぐ必要がある。

**Decision**：

* 重要判断は ADR として記録
* 変更時は ADR を追加・更新

**Consequences**：

* 設計レビューが容易
* ドキュメント維持コストが発生

---

## まとめ

この ADR 群は次を保証するためのものです。

* **再現性**
* **説明可能性**
* **運用安全性**
* **段階リリース耐性**

コードが進化しても、**「なぜそうなっているか」**を失わないための設計台帳として機能します。
