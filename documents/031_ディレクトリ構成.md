設計方針は以下を前提にしています。

* CLI / バッチ前提（UI・永続化は外出し）
* EOD 一方向パイプライン
* feature 分離原則（daily / static / fundamental）
* LLM は翻訳・監査レイヤー
* 段階リリース（M1 → M9）で壊れない構造
* 将来 Django API 化しても移植しやすい

---

## 推奨 `src/` ディレクトリ構成

```
src/
├── main.py                             　　# 実行のエントリポイント
│
└── market_decision_engine/
    ├── __init__.py                         # パッケージルート（公開APIは最小に）
    │
    ├── entrypoints/                        # main.pyのエントリポイント
    │   ├── __init__.py
    │   ├── parser.py                       # RunRequest への正規化（I/O境界）
    │   └── handler.py                      # RunRequest を main.run に渡す CLI ハンドラ
    │
    ├── config/                             # 設定の読み込み・デフォルト合成（検証はschemasへ寄せる）
    │   ├── __init__.py
    │   ├── defaults.py                     # デフォルト設定（最小）
    │   ├── loader.py                       # JSON/YAML等の読み込み（I/O）
    │   └── resolver.py                     # defaults + user config の合成（正規化）
    │
    ├── schemas/                            # 契約（Contract-first）：外部I/Fと内部境界をPydanticで固定
    │   ├── __init__.py
    │   ├── policy.py                       # UserPolicy / PolicySnapshot 実装済
    │   ├── decision.py                     # DecisionCore / DecisionPack（発注可能数値の契約） 実装済
    │   ├── features.py                     # Feature（日次/静的/財務）の契約 実装済
    │   ├── market.py                       # RunContext / MarketEnv / Regime 等（regimeのschemaはここ） 実装済
    │   └── reports.py                      # ShortSummary / Report の契約 実装済
    │
    ├── universe/                           # 対象銘柄集合（市場別・フィルタ）
    │   ├── __init__.py
    │   ├── base.py                         # Universe抽象（インタフェース）
    │   ├── jp.py                           # 日本株Universe実装
    │   ├── us.py                           # 米国株Universe実装
    │   └── filters.py                      # 除外条件（流動性など・ただしdaily根拠を侵食しない）
    │
    ├── data/                               # 外部データ取得（yfinance等）＋最低限の前処理
    │   ├── __init__.py
    │   ├── loaders/
    │   │   ├── __init__.py
    │   │   └── yfinance.py                 # yfinance専用ローダ（外部I/Oを局所化）
    │   └── preprocess.py                   # 欠損・整形（品質判定はスキップ/警告へ繋げる）
    │
    ├── features/                           # 特徴量生成（分離原則：daily/static/fundamental）
    │   ├── __init__.py
    │   ├── daily.py                        # OHLCV派生（候補抽出・Executionの主根拠）
    │   ├── static.py                       # 規模/流動性等（リスク補正にのみ使用）
    │   └── fundamental.py                  # 財務系（ML評価の段階導入、欠損多発を前提）
    │
    ├── regime/                             # 市場環境判定（保守化の根拠。価格決定には混ぜない）
    │   ├── __init__.py
    │   └── detector.py                     # MarketEnv/Regime生成（契約はschemas/market.py）
    │
    ├── selection/                          # 候補抽出（dailyのみで完結させる）
    │   ├── __init__.py
    │   ├── selector.py                     # 候補抽出ロジック（daily featureのみ参照）
    │   └── ranking.py                      # 候補内ランキング（ルールスコア等）
    │
    ├── plans/                              # 取引プラン（戦略）／カタログ駆動で差し替え可能に
    │   ├── __init__.py
    │   ├── catalog.py                      # plan_catalog読み込み・列挙
    │   ├── base.py                         # Plan抽象（共通I/F）
    │   └── swing.py                        # スイング系プラン例（M1は最小1本から）
    │
    ├── execution/                          # 発注可能数値の生成（決定論、dailyのみ参照）
    │   ├── __init__.py
    │   ├── entry.py                        # Entry算出
    │   ├── stop.py                         # Stop算出
    │   ├── target.py                       # Target算出（2R/3R等）
    │   ├── sizing.py                       # サイズ算出（基礎。補正はrisk側）
    │   └── executor.py                     # 統合（plan適用→execution_result生成）
    │
    ├── risk/                               # 補正・制約（価格は変えず、可否/サイズのみ安全側へ）
    │   ├── __init__.py
    │   ├── adjuster.py                     # static/regime等によるSizeModifier/Eligibility
    │   └── rules.py                        # 強制除外・安全側ロジック（フェイルセーフ連動）
    │
    ├── models/                             # ML評価（任意・縮退可能。M7で段階導入）
    │   ├── __init__.py
    │   ├── base.py                         # Model抽象（学習/推論分離の前提）
    │   ├── evaluator.py                    # p_success/ev_r/uncertainty推定
    │   └── registry.py                     # モデル登録・取得（実体差し替え）
    │
    ├── decision/                           # 最終判断生成（YES/YES_HALF/NO、rank確定）
    │   ├── __init__.py
    │   ├── composer.py                     # DecisionCore生成（契約準拠、曖昧はNOへ）
    │   ├── optimizer.py                    # plan比較（不確実性ペナルティ等）
    │   └── signals.py                      # buy_signal定義（3値固定）
    │
    ├── llm/                                # LLM層（翻訳・監査専用。DecisionCoreは改変しない）
    │   ├── __init__.py
    │   ├── prompts/
    │   │   ├── summary.txt                 # 要約プロンプト（数値生成禁止・判断基準追加禁止）
    │   │   └── validator.txt               # 監査プロンプト（契約逸脱検知）
    │   ├── summarizer.py                   # ShortSummary生成（失敗時は省略/テンプレ）
    │   └── linter.py                       # フォーマット監査・テンプレ強制
    │
    ├── reports/                            # 出力整形（Coreを守る。表現変更で結果を変えない）
    │   ├── __init__.py
    │   ├── json_report.py                  # JSON出力（json.py衝突回避）
    │   ├── markdown_report.py              # Markdown出力
    │   └── formatter.py                    # 共通整形（上位Nなどのまとめ）
    │
    ├── pipeline/                           # EOD一方向パイプライン（オーケストレーション）
    │   ├── __init__.py
    │   ├── eod.py                          # 全体の手続き（Step順序・縮退適用）
    │   └── context.py                      # RunContext生成（契約はschemas/market.py）
    │
    ├── utils/                              # 共通ユーティリティ（標準ライブラリ名衝突を避ける）
    │   ├── __init__.py
    │   ├── loggers.py                      # ログ整形・run_id紐付け（logging.py回避）
    │   ├── time_utils.py                   # 日付・asof処理（time.py回避）
    │   └── math_utils.py                   # 数学補助（math.py回避）
    │
    └── exceptions.py                       # 共通例外（Fatal/Degraded/Skip等の概念を集約） 実装済

```

---

## この構成の設計意図（重要）

### 1. **外部設計と 1:1 対応**

* 外部設計の章立て（Universe / Feature / Execution / Decision / LLM）が
  そのままディレクトリ責務になっています。
* 「どこを読めば何が分かるか」が一意。

### 2. **feature 分離原則が壊れない**

* `features/` を daily / static / fundamental に物理分離
* execution は daily しか import できない設計にしやすい

### 3. **LLM の暴走を構造で防ぐ**

* `llm/` は `decision/` の後段にのみ存在
* DecisionCore を import しない設計が可能（翻訳専用）

### 4. **段階リリース耐性**

* M1：`cli / data / features/daily / execution / decision / reports`
* M2：`risk / utils / logging`
* M3 以降：`models / llm / regime`

### 5. **将来 API 化しやすい**

* `pipeline.eod.run()` を FastAPI/Django からそのまま呼べる
* CLI は `cli/` に閉じているため置換容易

---