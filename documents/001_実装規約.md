# market-decision-engine 実装規約

## 0. 適用範囲と目的

* 適用範囲：`src/market_decision_engine/**`、`tests/**`、設定/スキーマ/パイプライン/CLI/モデル/LLM層。
* 目的：

  * **再現性（同一入力→同一出力）**
  * **安全側の縮退（fail-safe）**
  * **契約（schema）による境界の明確化**
  * 段階導入でも破綻しない拡張性

---

## 1. 言語・スタイル・静的解析

### 1.1 Python バージョン

* Python `>=3.11`

### 1.2 フォーマッタ／インポート

* `black`：必須
* `isort`：必須（black profile）
* 例外：なし（CIで強制）

### 1.3 Linter / Type checker

* `ruff`：必須（警告は原則ゼロ）
* `mypy`：必須（`strict` 相当）
* 例外を作る場合：

  * 例外理由を PR 内に明示
  * `# noqa: <RULE>` や `# type: ignore[code]` は **最小範囲**で使用し、理由コメント必須

### 1.4 命名規約

* module / function / variable：`snake_case`
* class：`PascalCase`
* 定数：`UPPER_SNAKE_CASE`
* 例外：外部I/Fキー名（JSON）に合わせる場合は Pydantic の alias を使用

---

## 2. Pydantic 優先のデータ規約（最重要）

### 2.1 原則

* **ドメインデータ／I/F契約／設定／中間成果物**は **Pydantic を第一選択**とする。
* `dataclasses.dataclass` は原則禁止（次の例外のみ許可）。

### 2.2 dataclass の例外（許可条件）

* 高頻度ループの内部で、完全にローカルで閉じた「一時的な軽量構造体」が必要で、かつ

  * 外部I/Fに出ない
  * 永続化しない
  * ログ出力しない
  * schema として扱わない
* その場合でも、外側境界（pipeline 入出力）では Pydantic に変換する。

### 2.3 Pydantic の利用方針（標準）

* Pydantic v2 前提（`BaseModel` / `field_validator` / `model_validator`）
* `ConfigDict` を標準化（例：`frozen=True`、`extra="forbid"` 等）
* `extra="forbid"` を原則（契約逸脱の早期検出）
* `validate_assignment=False` を原則（不変データとして扱う）
* 変更は **新しいインスタンスを生成**する（イミュータブル設計）

#### 推奨設定（デフォルト）

* `frozen=True`
* `extra="forbid"`
* `use_enum_values=True`（必要な場合）
* `populate_by_name=True`（alias 運用する場合）

### 2.4 Schema の責務分離

* `schemas/` 配下の Pydantic は「契約」を表す。
* 実装都合のフィールド追加を禁止（必要なら別モデルに分離）。
* 外部I/Fモデルと内部処理モデルを混同しない。

  * 例：`DecisionCore`（外部契約）と `DecisionDraft`（内部中間）を分ける。

---

## 3. 例外・エラー処理（Fail-safe 設計）

### 3.1 原則

* EOD パイプラインは **銘柄単位で失敗しても全体が落ちない**こと。
* 例外は以下の 2 種に分類する。

  1. **致命的（市場単位で中断）**：設定不備、依存ライブラリ不整合、入出力契約破壊など
  2. **非致命的（銘柄単位スキップ）**：データ欠損、計算不能、モデル未ロードなど

### 3.2 例外クラス規約

* `market_decision_engine/exceptions.py` に集約
* 例外メッセージは **英語**（運用ログ・CI解析の一貫性）
* 例外には `reason_code`（Enum）を持たせることを推奨

### 3.3 warnings の扱い

* Decision Pack の `warnings` は **固定語彙（catalog/vocabulary）**に限定
* 例：`DATA_GAP`, `LOW_LIQUIDITY`, `MODEL_UNAVAILABLE` 等
* 実装では `WarningCode` Enum を使用し、出力では文字列化

---

## 4. ログ・観測性（Observability）

### 4.1 原則

* ログは「再現性・監査」を目的に、**入力条件と出力要約**を残す。
* 個人情報・秘匿情報（APIキー等）は絶対にログに出さない。

### 4.2 ログ粒度

* pipeline 開始・終了：INFO
* 銘柄スキップ：WARNING（reason_code付き）
* 予期せぬ例外：ERROR（スタックトレース）
* デバッグは DEBUG（CI/本番ではOFF）

### 4.3 ログ出力形式

* JSONログ推奨（後で分析しやすい）
* 最低限含める：`run_id`, `market`, `asof`, `ticker`, `step`, `reason_code`

---

## 5. 依存関係・レイヤリング（Import 規約）

### 5.1 レイヤ境界（厳守）

* `pipeline/` はオーケストレーションのみ
* `execution/` は **features_daily のみ**参照可能（static/fundamental 禁止）
* `risk/adjuster` は static を参照して良いが **価格計算を変更禁止**
* `llm/` は `decision_core` を **変更禁止**（読み取りのみ）
* `schemas/` は最下層（どこからでも import 可）
* 逆方向 import（下層→上層）は禁止

### 5.2 禁止事項

* `selection/` が `llm/` を import
* `execution/` が `features/static.py` を import
* `schemas/` が `pipeline/` を import

---

## 6. 関数・クラス設計規約

### 6.1 関数は「単一責務 + 明確な契約」

* 入力：Pydantic Model or primitive
* 出力：Pydantic Model or primitive
* 返り値に `dict` を乱用しない（境界は schema 化）

### 6.2 不変データの原則

* `DecisionCore` は生成後に変更しない
* 途中結果は `DecisionDraft` 等の別モデルに積む

### 6.3 純粋関数を優先

* 同じ入力なら同じ出力（乱数を使うなら seed を明示）
* 時刻依存は `asof` を入力として受け取る

---

## 7. 設定・カタログ規約

### 7.1 設定ファイル

* JSON/YAML は `config/loader.py` で読み込み、Pydantic で validate
* 生の辞書をパイプライン内に流さない

### 7.2 カタログ（plan_catalog / vocabulary）

* `catalog/` は「固定語彙・固定ID」を提供する責務
* 変更時はバージョンを上げ、互換性を文書化

---

## 8. LLM 実装規約（安全設計）

### 8.1 入力と出力

* LLM は `ShortSummary` のみ生成
* `DecisionCore` の数値を再計算しない
* 出力は linter/validator で構造検証し、違反時はテンプレへ強制

### 8.2 プロンプト管理

* `llm/prompts/` 配下に配置（コードに直書きしない）
* Prompt の変更は「仕様変更」として扱い、レビュー必須

---

## 9. テスト規約（pytest）

### 9.1 テスト階層

* unit：各モジュールの純粋関数・バリデーション
* integration：EODパイプライン最小 E2E（yfinance はモック）
* contract：Decision Pack の schema 合致、警告語彙制約

### 9.2 最低保証

* 代表銘柄 1〜3 件で E2E が落ちない
* 欠損時に NO/スキップへ縮退する
* LLM なしでも DecisionCore が出る

---

## 10. ドキュメンテーション規約

### 10.1 Docstring

* すべての public 関数・public クラスに docstring 必須
* 形式：Google style
* 言語：日本語
* 例外メッセージは英語

### 10.2 コメント

* 日本語
* 「何をしているか」ではなく **設計意図・制約理由**を書く（理由のコメント）

---

## 11. 代表テンプレ（推奨パターン）

### 11.1 Pydantic Model（契約）テンプレ

* `extra="forbid"`
* `frozen=True`
* validator は「契約違反」を早期に落とす

### 11.2 Step 関数テンプレ

* `StepInput`（Pydantic）→ `StepOutput`（Pydantic）
* `warnings` を蓄積、例外は分類してスキップ/中断を決める

---

## 12. 禁止事項まとめ（短縮版）

* dataclass を契約/I-Fで使うこと（原則禁止）
* dict を中間成果物として流すこと（schema 化）
* execution が static/fundamental を参照すること
* LLM が DecisionCore を変更すること
* 生の設定値を pipeline 内に持ち込むこと（必ず validate）