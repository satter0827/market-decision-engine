以下は「最後の設計」として、第三者が読んで理解でき、かつ **AIに読み込ませて実装に落とせる**ことを前提にした **詳細README叩き台**です。
全要素を **目的 / 入力 / 処理 / 出力 / ルール / 失敗時** の同一粒度で統一しています。

---

# AI-Orchestrated Trading System

**yfinance起点 / Quant×ML×AI要約 / 再現性・責任分界重視 / JP&US対応**

## 0. これは何か

本システムは、yfinance から取得できる株価データ（主に日足OHLCV）を用いて、毎営業日（市場終了後）に

* **銘柄候補**
* **発注可能な具体値**（Entry / Stop / Target / Size）
* **信用度**（成功確率・期待値・不確実性）
* **短文要約（最大3文＋If-Then 1文）**

を自動生成し、ユーザー（人間）が最終判断して発注するための **投資判断支援アプリ**です。

このシステムは「当てにいく」よりも「再現可能に運用する」ことを重視します。
AI（LLM）は数値の生成や売買判断の改変を行いません。AIの役割は **数字の説明（翻訳）** と **フォーマット監査**に限定されます。

---

## 1. 想定ユースケース

* 平日日中は本業があり、トレードに使える時間は **朝30分＋夜30分程度**
* 市場終了後に自動実行し、結果をメールで受け取る
* 投資期間は **2〜3週間〜3ヶ月（最大半年程度）**
* 日本株と米国株を両方扱う
* 個人投資家として **特権的な情報アクセスはない**
* プログラムが得意で、計算とレポート生成は自動化できる

---

## 2. スコープと非スコープ

### スコープ

* 対象市場：JP / US
* データ：yfinance（取得可能データは「収集」する）
* 分析：日足ベース（EOD）
* 出力：銘柄ごとの Decision Pack（機械可読＋人間可読）
* 実行：市場別にEODバッチ
* 改善：週次/月次で外側ループ

### 非スコープ（設計上やらない）

* LLMが数値（Entry/Stop/Size）を生成する
* LLMが売買シグナルを独自に変える
* ティック/分足などの高頻度データ前提
* ニュース、SNS、オーダーブック等の外部データ（初期設計では扱わない）
* 発注API連携（最終判断は人間、発注は別途）

---

## 3. 最重要の設計原則

1. **判断は数字で完結**（DecisionCoreが主）
2. **説明は短文で補助**（短文は判断基準を増やさない）
3. **AI（LLM）は翻訳器**（数値生成・判断介入禁止）
4. **AI層内部は一方向（非循環）**（同一入力→同一出力を原則）
5. **改善は運用の外側で循環**（週次/月次の検証・更新）
6. **Featureは用途別に分離**（「混ぜるな危険」を設計で回避）
7. **責任は常に人間**（最終決定と損益責任）

---

## 4. 全体アーキテクチャ（高レベル）

```
UserPolicy(JSON)
  ↓
Universe Provider
  ↓
Data Loader (yfinance)
  ↓
Feature Generator (daily/static/fundamental)
  ↓
Market Regime Detector
  ↓
Candidate Selector
  ↓
Plan Factory (離散引数列挙)
  ↓
Execution Tool (ヒューリスティックでEntry/Stop/Target/Size)
  ↓
Risk/Sizing Adjuster (staticで補正・見送り判定)
  ↓
ML Evaluator (P_success/EV_R/Uncertainty)
  ↓
Plan Optimizer
  ↓
Decision Composer (YES/YES_HALF/NO)
  ↓
AI Layer (短文要約・フォーマット監査)
  ↓
Decision Pack (配信/保存)
```

---

## 5. 入出力契約（Contracts）

### 5.1 UserPolicy（ユーザー入力 JSON）

**目的**
ユーザーの運用方針を構造化し、運用を再現可能にする。

**入力**

* 市場（JP/US）、保有期間レンジ
* リスク（1トレード損失%、最大DD%）
* 制約（同時保有数、テーマ集中上限）
* 判断閾値（min_success_prob、min_expected_r、max_uncertainty）
* 実行設定（YES_HALFの扱い、利確方式、タイムストップ）
* レポート設定（言語、短文化）
* 任意：意思ログ短文（「方針の宣言」1〜2文）

**処理**

* JSON Schema 検証
* デフォルト補完
* policy_snapshot_id 発行（バージョン管理）

**出力**

* validated_user_policy
* policy_snapshot_id

**ルール**

* UserPolicyは日次で頻繁に変更しない（検証不能になるため）
* 変更する場合は policy_snapshot_id を必ず更新する

**失敗時**

* バリデーションエラーを返し、日次処理を停止（推奨）

---

### 5.2 Decision Pack（システム出力）

#### A) DecisionCore（機械可読：発注可能）

**目的**
採用すればそのまま発注できる具体値を提供する。

**入力**

* best_plan（Execution + ML評価）
* UserPolicy（制約）

**処理**

* BUY判定（YES/YES_HALF/NO）
* 発注値の確定（Entry/Stop/Target/Size）
* リスク値の確定（MaxLoss/TimeStop）
* ランク付け

**出力（最低限）**

* ticker
* buy_signal（YES/YES_HALF/NO）
* entry / stop / target_2r / target_3r
* position_size / max_loss / time_stop_days
* p_success / ev_r / uncertainty / plan_score / rank
* plan_args
* policy_snapshot_id

**ルール**

* LLMは DecisionCore を改変しない
* BUY語彙は3値固定

**失敗時**

* NO に倒す（安全側）

#### B) ShortSummary（人間可読：短文）

**目的**
数字の解釈を短時間で行えるよう、根拠とリスクを短文化する。

**入力**

* decision_core
* key_features（根拠に使う少数）
* market_env
* UserPolicy（閾値とレポート設定）

**処理**

* 固定語彙ラベル（Profile）
* Strength 1文、Risk 1文、If-Then 1文（任意）に圧縮
* warnings（最大3）付与

**出力**

* profile（固定語彙1行）
* strength（1文）
* risk（1文）
* if_then（任意、1文）
* warnings（任意、最大3）

**ルール**

* 最大3文＋If-Then 1文
* 新しい判断基準を追加しない
* 数値生成禁止

**失敗時**

* 定型テンプレにフォールバック

---

## 6. Feature Group 分割（混ぜるな危険の具体策）

### 6.1 features_daily（EOD更新、実行の主役）

**目的**
候補抽出と実行値生成に使う、リークのない日次特徴量を提供する。

**入力**

* OHLCV（日足）

**処理（例：最低限）**

* returns_1d/5d/20d/60d
* ATR_14, ATR_ratio
* SMA50/200_ratio
* ADX_14
* volume_ratio（Volume/MA20）
* RS_20/60（指数対比）
* range_position_252（52週レンジ内位置）
* gap_pct

**出力**

* features_daily[ticker]

**ルール**

* Candidate Selector と Execution Tool は daily 以外を参照しない

**失敗時**

* 当該銘柄を除外（または欠損フラグ付きでMLのみへ）

---

### 6.2 features_static（静的/低頻度、補正の主役）

**目的**
事故率低減（ギャップ・流動性・集中）に使う補正情報を提供する。

**入力**

* yfinanceから取得可能な銘柄属性（例：marketCap、averageVolume、sector等）

**処理**

* 流動性ランク
* サイズ補正係数（SizeModifier）
* セクター/テーマ集中フラグ

**出力**

* features_static[ticker]

**ルール**

* Entry/Stop/Targetの計算には混ぜない
* Risk/Sizing Adjuster でのみ使用し、サイズ・可否に反映

**失敗時**

* 補正なし（modifier=1.0）＋warnings

---

### 6.3 features_fundamental（低頻度、評価の拡張）

**目的**
ML評価の説明力を上げるための拡張入力（段階導入）。

**入力**

* 財務・バリュエーション等（yfinance由来）

**処理**

* asof_date（市場で利用可能になった日）付与（可能な範囲）
* 欠損フラグ作成

**出力**

* features_fundamental[ticker]

**ルール**

* asof_dateが不明なものは原則ML入力に入れない（リーク防止）
* MLへの投入は段階導入（daily→+static→+fundamental）

**失敗時**

* fundamental無効化して継続（warnings）

---

## 7. モジュール仕様（全要素：同一粒度）

### 7.1 Universe Provider

**目的**
市場別の対象銘柄集合（Universe）を確定する。

**入力**

* market（JP/US）
* UserPolicy（除外条件）

**処理**

* Universe読み込み（S&P500 / TOPIX系 / watchlist）
* 除外条件適用（停止銘柄など）

**出力**

* tickers[]

**ルール**

* Universeは日次で激しく変えない（検証性）

**失敗時**

* 空なら停止

---

### 7.2 Data Loader（yfinance）

**目的**
Universeの全銘柄について、必要期間の日足データを取得する。

**入力**

* tickers[]
* lookback_days（例：400〜600営業日）

**処理**

* yfinance取得
* 欠損検出、異常値検出
* キャッシュ（再実行高速化）

**出力**

* ohlcv[ticker]

**ルール**

* 欠損が多い銘柄は除外

**失敗時**

* 銘柄単位でスキップ＋warnings

---

### 7.3 Feature Generator

**目的**
daily/static/fundamentalに分類された特徴量を生成する。

**入力**

* ohlcv[ticker]
* yfinance追加データ（可能なら）

**処理**

* daily生成
* static生成
* fundamental生成（asof_date前提）

**出力**

* features_daily/static/fundamental

**ルール**

* 未来情報の混入禁止（リーク防止）

**失敗時**

* グループ単位で無効化し warnings

---

### 7.4 Market Regime Detector

**目的**
市場環境（リスクオン/オフ等）を確定する。

**入力**

* index_ohlcv
* UserPolicy（リスクオフ時方針）

**処理**

* トレンド判定（例：指数が長期MA上か）
* ボラ判定（例：ATR/Close）

**出力**

* market_env（regime, volatility_state など）

**ルール**

* regime=OFF時の新規禁止などはUserPolicyに従う

**失敗時**

* 保守的にOFF

---

### 7.5 Candidate Selector

**目的**
トレード検討に値する候補銘柄を抽出する。

**入力**

* features_daily
* market_env
* UserPolicy（フィルタ）

**処理（例）**

* ブレイク＋出来高条件
* 除外（過大ギャップ、過大ボラ等）
* 上位N制限

**出力**

* candidates[]（ticker + 主要特徴参照）

**ルール**

* Candidate抽出は daily のみ参照

**失敗時**

* 候補ゼロなら当日は NO のみ配信

---

### 7.6 Plan Factory

**目的**
ヒューリスティックの引数セットを離散的に列挙する。

**入力**

* PlanCatalog（定義済み候補）
* UserPolicy.execution_preference

**処理**

* k_stop、m_target、time_stop等の組合せ生成（上限M）

**出力**

* plan_args_set[]

**ルール**

* 引数候補はカタログで管理（検証可能にする）

**失敗時**

* 既定1セットにフォールバック

---

### 7.7 Execution Tool（ヒューリスティック）

**目的**
Entry/Stop/Target/Sizeを決定論で生成し、発注可能な形にする。

**入力**

* features_daily（必須）
* account_state（資金）
* plan_args（k_stop, target倍率, time_stop, risk_pct 等）

**処理（例）**

* entry：ブレイク水準 or 終値基準
* stop：entry - k_stop * ATR
* R：entry - stop
* target_2r/3r：entry + 2R / 3R
* size：資金×risk_pct / R（売買単位で丸め）
* max_loss：R×size

**出力**

* execution_result（entry/stop/targets/size/max_loss/time_stop + rule_passed）

**ルール**

* Executionは daily のみ参照（混ぜない）
* Rが極小なら除外（サイズ過大になる）

**失敗時**

* rule_passed=false + reject_reason

---

### 7.8 Risk/Sizing Adjuster（補正レイヤー）

**目的**
事故率低減のため、静的情報で「サイズ補正」または「見送り」を適用する。

**入力**

* execution_result
* features_static
* market_env
* UserPolicy（集中上限等）

**処理**

* SizeModifier適用（例：低流動性なら0.5）
* TradeEligibility判定（例：流動性不足ならNO）
* 集中フラグ（同テーマ過多）で YES→YES_HALF などの制御材料を出す

**出力**

* adjusted_execution_result（size調整・eligibilityフラグ）

**ルール**

* Entry/Stop/Targetは変更しない（サイズと可否のみ）

**失敗時**

* 補正なし（modifier=1.0）＋warnings

---

### 7.9 ML Evaluator

**目的**
各案について、成功確率・期待値・不確実性を推定し比較可能にする。

**入力**

* features_daily（必須）
* features_static（任意）
* features_fundamental（任意、asof_date前提）
* plan_args
* adjusted_execution_result

**処理**

* p_success, ev_r, uncertainty 推論
* 確率校正（学習側で実施済みの前提）

**出力**

* ml_eval（p_success/ev_r/uncertainty + health_flags）

**ルール**

* 入力拡張は段階導入（daily→+static→+fundamental）
* ML不調時は保守運用に縮退

**失敗時**

* ml_degradedフラグ＋以降の意思決定を保守化

---

### 7.10 Plan Optimizer

**目的**
複数の plan_args 案から最良案を選択する。

**入力**

* adjusted_execution_result[]
* ml_eval[]
* UserPolicy（優先順位、閾値）

**処理**

* スコアリング（例：EV_R - λ*uncertainty）
* tie-break（成功確率優先→不確実性低い→流動性）

**出力**

* best_plan

**ルール**

* 不確実性にペナルティを常に付与

**失敗時**

* NOに倒す

---

### 7.11 Decision Composer

**目的**
best_planを閾値と制約に照らしBUY判定を確定する。

**入力**

* best_plan
* UserPolicy（閾値）
* PortfolioPolicy（同時保有、集中）

**処理**

* 閾値判定：P_success / EV_R / uncertainty
* 制約判定：同時保有、テーマ集中、regime
* BUY判定：YES / YES_HALF / NO

**出力**

* decision_core

**ルール**

* BUY語彙は3値固定
* 不明時はNO（安全側）

**失敗時**

* NOに倒す

---

## 8. AI層（LLM層）：非循環の翻訳器

### 8.1 AI層の目的

* decision_core を短文に翻訳し、人間が判断しやすくする
* 出力フォーマットを厳密に守らせる（監査）

### 8.2 AI層の入力

* decision_core
* key_features（根拠用の少数）
* market_env
* UserPolicy.report_preference（短文化設定）

### 8.3 AI層の処理（内部一方向）

* Contract Validator
  → Policy Interpreter（数値→意図ラベル）
  → Strategy Labeler（PlanArgs→固定語彙）
  → Evidence Selector（根拠1文）
  → Risk Selector（リスク1文）
  → If-Then Generator（1文）
  → Writer（整形）
  → Linter（規約監査）

### 8.4 AI層の出力

* short_summary（最大3文＋If-Then 1文）
* warnings（最大3）

### 8.5 AI層のルール

* 数値生成禁止
* 判断基準追加禁止
* 固定語彙のみ使用
* 規約違反時はテンプレに強制フォールバック

### 8.6 AI層の失敗時

* short_summary を最小テンプレで出力
* decision_core は必ず保持

---

## 9. フェイルセーフ（全体）

* **LLM障害**：DecisionCoreのみ配信（short_summaryなし）
* **ML不調**：YESをYES_HALF/NOに寄せる（保守運用）
* **データ欠損**：当該銘柄除外＋warnings
* **フォーマット違反**：Linterで強制修正

---

## 10. 実行スケジュール（運用）

### 日次（市場終了後）

* JP市場：EOD後に実行→メール配信
* US市場：EOD後に実行→メール配信
* 上位N銘柄をランキングして提示

### 週次/月次（外側循環）

* 取引結果の集計（勝率、EV、DD、分布）
* MLの再学習・再校正
* PlanCatalog・閾値の見直し（変更はバージョン管理）

---

## 11. 最小実装（MVP）

* Universe Provider
* Data Loader（yfinance）
* Feature Generator（daily最小セット）
* Market Regime Detector
* Candidate Selector
* Execution Tool（1戦略、少数引数）
* Risk/Sizing Adjuster（static最小）
* ML Evaluator（p_successのみでも可）
* Decision Composer
* AI Reporter（短文3文＋Linter）
* Email Packager

---

## 12. 将来拡張（バックログ）

* Intent Auditor AI（UserPolicyが意図を表現できているかの監査）
* Model Health Monitor（ドリフト・校正監視）
* Strategy Catalog ABテスト（PlanArgs比較）
* 決算直前回避などの例外ルール（ただし簡単に増やさない）

---

## 13. 実装者向け補足（AI実装前提）

本READMEは、実装に必要な“仕様”を文章化したものです。
AIに実装させる場合は、以下を別ファイルで併用すると確実です。

* `schemas/user_policy.schema.json`
* `schemas/decision_core.schema.json`
* `schemas/decision_pack.schema.json`
* `plan_catalog.json`（引数候補）
* `vocabulary.json`（固定語彙辞書：Strategy Labeler用）
* `prompts/`（AI層のプロンプト群：Label/Evidence/Writer/Linter）

---

必要であれば、このREADMEに完全整合する形で次を作れます（実装の“最後の穴埋め”です）。

* **3つのJSON Schema**（UserPolicy/DecisionCore/DecisionPack）
* **固定語彙辞書（vocabulary.json）**の叩き台
* **AI層プロンプト（4本：Validator/Labeler/Evidence/Writer-Linter）**の叩き台
