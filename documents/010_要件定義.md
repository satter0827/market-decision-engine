了解しました。
添付の **要件定義書（010_要件定義.md）** は内容としては非常に良いのですが、現在の形は **「要件定義」＋「外部設計」＋「内部設計」＋「実装仕様」** が混在しています。
そのため、

* 要件として固定すべきもの
* 設計・実装で決めればよいもの

が曖昧になっています。

ここでは **要件定義書として適切な粒度に整理し直した“書き直し版”** を提示します。
（※アルゴリズム・算出式・Step詳細は削減または抽象化し、「何を満たすべきか」に集中させています）

---

# 要件定義書（改訂版）

## 0. 本書の位置づけ

本書は **market-decision-engine** において、

* 何を作るか
* 何を作らないか
* 何を満たせば「完成」と言えるか

を定義する **最上位ドキュメント** である。
設計・実装・自動生成は、本書に反してはならない。

---

## 1. システムの目的

本システムは、株式市場の **EOD（市場終了後）** において、

* 銘柄候補
* 発注可能な具体値（Entry / Stop / Target / Size）
* 取引案の信用度（成功確率・期待値・不確実性）
* 人間が短時間で理解できる短文要約

を **自動生成** し、
**最終判断を行う人間の意思決定を支援する** ことを目的とする。

本システムは「当てる」ことではなく、
**再現可能・検証可能・安全側に倒れる運用** を最優先とする。

---

## 2. 利用者像・利用シナリオ

### 想定利用者

* 個人投資家
* 平日日中は本業があり、トレードに使える時間は限定的
* 計算・集計・レポート生成は自動化したい
* 特権的な情報アクセス（未公開情報・高速執行）は持たない

### 想定ユースケース

* 市場終了後に自動実行
* 出力結果をまとめて確認
* 数値を見て人間が最終判断
* 投資期間は **数週間〜数か月（最大半年程度）**
* 日本株・米国株を対象とする

---

## 3. スコープ

### 3.1 本システムが行うこと（MUST）

* 対象市場：日本株（JP）、米国株（US）
* データソース：yfinance から取得可能なデータ
* 分析粒度：日足（EOD）
* 出力単位：銘柄ごとの **Decision Pack**
* 実行形態：市場別 EOD バッチ
* 人間による最終判断を前提とした判断支援

### 3.2 本システムが行わないこと（MUST NOT）

* LLMが数値（Entry / Stop / Size 等）を生成・変更すること
* LLMが売買判断を独自に変更すること
* ティック・分足など高頻度データ前提の分析
* ニュース、SNS、板情報などの外部データ利用（初期段階）
* 証券会社APIによる自動発注

---

## 4. 最重要設計原則（要件として固定）

1. **判断は数字で完結する**

   * 主体は機械可読な数値情報である
2. **説明は補助であり、判断基準を増やさない**
3. **LLMは翻訳器である**

   * 数値生成・判断介入は禁止
4. **同一入力から同一出力が得られる**

   * 再現性を最優先とする
5. **失敗時は常に安全側に倒れる**
6. **Featureは用途別に分離される**
7. **最終責任は常に人間が負う**

---

## 5. 入出力に関する要件

### 5.1 入力（UserPolicy）

* ユーザーの運用方針は構造化された設定として与えられる
* 方針は頻繁に変更されないことを前提とする
* 方針変更は識別可能でなければならない

### 5.2 出力（Decision Pack）

Decision Pack は以下を満たす必要がある。

* 発注に必要な数値を含むこと
* 判断に必要な信用度指標を含むこと
* 人間が短時間で理解できる短文要約を含むこと
* 数値と文章が矛盾しないこと

---

## 6. 非機能要件（NFR）

### 再現性

* 同一入力条件で同一出力が得られること

### 信頼性

* 一部銘柄の失敗で全体が停止しないこと

### 可観測性

* 実行結果・警告・失敗理由が追跡可能であること

### 運用性

* 日次で再実行可能であること
* JP / US 市場を独立して運用できること

---

## 7. フェイルセーフ要件

* データ欠損時：該当銘柄を除外し処理を継続
* ML不調時：判断を保守側に縮退
* LLM不調時：数値出力を維持し文章を省略
* 不明確な場合：必ず NO 判定に倒す

---

## 8. 責任と免責

* 本システムは投資助言ではない
* 出力結果の利用は利用者の自己責任とする
* 最終的な売買判断および損益責任は人間が負う

---

## 9. 成功条件（Acceptance Criteria）

### M1（最小成立条件）

* Decision Pack が出力される
* 欠損があってもシステムが落ちない
* 同一入力で同一出力が得られる
* JP / US 市場別に実行可能

### M2 以降（拡張条件）

* 出力の安定性が検証可能
* 縮退挙動が一貫している
* 運用改善が外側ループで可能

---

## 10. 非目標（明示）

以下は本要件定義では目標としない。

* 市場平均を上回るリターンの保証
* 予測精度の最大化
* 完全自動売買

---

## 11. 他ドキュメントとの関係

| ドキュメント | 本書との関係           |
| ------ | ---------------- |
| 外部設計書  | 本書を満たす具体的振る舞いを定義 |
| 内部設計書  | 本書を満たす構造を定義      |
| 実装規約   | 本書を破らないための制約     |
| ADR    | 本書に基づく判断理由の記録    |

---

### 総評

* **要件定義としては過剰だった実装詳細を整理**
* **「MUST / MUST NOT / 成功条件」を明確化**
* 自動実装・段階リリースに耐える「ぶれない上位文書」になっています

次にやると一番噛み合うのは
**外部設計書との対応表（要件 → 外部設計項目）作成** です。
