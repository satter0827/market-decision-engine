# フェイルセーフ設計書（Failure Modes & Fallback Policy）

## market-decision-engine

## 0. 目的と範囲

本書は、EODパイプラインにおける障害・異常・不確実性に対して、
**停止するのか／継続するのか／縮退するのか**の判断を一貫させるための設計方針を定める。

* 対象：JP/US EODバッチ、Decision Pack 出力、メール配信（将来）
* 対象外：個別アルゴリズムの数式、型、詳細な検証実装（コードで担保）

---

## 1. 基本原則（フェイルセーフの思想）

1. **“落ちない”より“誤ってYESを出さない”を優先**する

   * 不明・曖昧・不確実は **NO（またはYES_HALF）** に倒す
2. **障害は局所化（銘柄単位）**する

   * 1銘柄の失敗で市場バッチを落とさない
3. **停止は「全件に影響する契約違反」に限定**する

   * 設定不備、契約破壊など
4. **DecisionCoreを最優先で守る**

   * Summary/通知は落としてよいが、Coreは可能な限り出す
5. **縮退は“保守化の方向”を一貫させる**

   * サイズを減らす、候補を絞る、YES→YES_HALF→NO の順に弱める

---

## 2. 失敗の分類（停止 vs 継続）

失敗は以下の3カテゴリに分類する。

### 2.1 Fatal（市場バッチ停止）

**定義**：当日出力の信頼性が全体として担保できない／入力契約が成立していない。
**例（代表）**

* UserPolicy の検証失敗（契約違反）
* Universe が確定できない、または空（運用ポリシー次第だが原則停止）
* 出力契約（Decision Pack）が生成不能になる内部破壊（コードの不整合）

### 2.2 Degraded（市場バッチ継続・品質低下）

**定義**：全体は実行できるが、一部機能が失われる（保守化が必要）。
**例（代表）**

* 市場データ取得不能 → regime 判定を保守固定
* ML 不調 → 予測を使わず保守化
* LLM 不調 → ShortSummary を省略／テンプレ

### 2.3 Non-fatal（銘柄単位のスキップ）

**定義**：銘柄に閉じた問題であり、当該銘柄のみ対象外にできる。
**例（代表）**

* データ欠損、lookback不足
* 実行値計算不能（plan reject）
* 異常値（出来高ゼロが継続、価格不連続が過大）

---

## 3. フェイルセーフの適用順序（優先順位）

複数の問題が同時に起きた場合、判断は次の順序で適用する。

1. **契約の成立（Policy/Universe）**
   成立しないなら停止（Fatal）
2. **DecisionCore の生成可否**
   Coreが生成できないなら、当該銘柄は NO（またはスキップ）、全体は継続
3. **保守化（Degraded）**
   ML/Regime/Static 欠損などによる保守補正を適用
4. **ShortSummary（LLM）**
   最後。失敗しても core は維持

---

## 4. Step別の縮退方針（最小）

詳細な例外一覧ではなく、「縮退の方向」をStep種別で固定する。

### 4.1 入力確定系（Policy / Universe）

* 失敗時：**停止（Fatal）**
* 理由：入力が不確定なまま進めると、全出力が監査不能になる

### 4.2 データ取得系（Market / Ticker）

* Marketデータ失敗：**regimeを保守固定**し継続（Degraded）
* Tickerデータ失敗：**銘柄スキップ**（Non-fatal）
* 理由：市場データは補助、銘柄データは当該銘柄の根拠そのもの

### 4.3 特徴量生成（daily/static/fundamental）

* daily 不成立：**銘柄スキップ**
* static 不成立：**補正弱化（サイズ増はしない）＋warnings**
* fundamental 不成立：**fundamental 無効化→ML縮退＋warnings**

### 4.4 実行値生成（execution）

* plan 単位で reject（計算不能・条件不一致）：**そのplanを除外**し継続
* 全plan reject：**当該銘柄は NO（またはスキップ）**
* 理由：発注可能性の担保が最優先。曖昧なら採用しない。

### 4.5 リスク補正（risk/sizing）

* 補正不能：**補正なし（modifier=1.0）**で継続
* ただし補正が「安全側」にならない場合は、最終的に **サイズを減らす方向**を優先

### 4.6 ML評価（任意）

* ML不調（モデル未ロード、入力不足、推定不安定）：**degraded** として

  * p_success/ev/uncertainty を使わず保守化
  * YES を弱める（YES_HALF or NO）方向へ
* 理由：MLは価値を上げるが、依存すると運用が壊れる

### 4.7 最終決定（decision compose）

* 不明・矛盾・整合不能：**NOに倒す**
* 理由：誤ってYESを出すより、見送る方が安全

### 4.8 LLM要約（任意）

* LLM不調：**short_summary省略**（またはテンプレ）
* Linter違反：**テンプレに強制**
* 理由：LLMは補助。coreを守る。

### 4.9 出力・配信

* ファイル出力/整形失敗：可能な範囲で **coreの標準出力**に縮退
* メール失敗：次回再送可能な形で、少なくともローカル成果物を残す設計（運用で吸収）

  * ※永続化対象外でも、当日成果物の一時保存は「配信の代替」として許容される設計が望ましい

---

## 5. “保守化”の定義（縮退の方向性を固定）

保守化とは、次のいずれか、または複合である。

1. **BUY判定の弱化**：YES → YES_HALF → NO
2. **サイズの縮小**：position_size を減らす（増やさない）
3. **候補の縮小**：ランキング下位を切る／閾値を厳しくする
4. **説明の縮小**：ShortSummary省略・簡略化

---

## 6. 監査・可観測性（言語化が必要な最小要件）

コードでログ出力は可能だが、「何を残すべきか」の合意を固定する。

### 6.1 必ず残すべき（市場実行のサマリ）

* run_id / market / asof / policy_snapshot_id / universe_id
* 処理件数：universe数、処理成功数、スキップ数、NO数、YES数、YES_HALF数
* degraded フラグ（ML/LLM/MarketDataなど、カテゴリ別）

### 6.2 銘柄単位で残すべき（スキップ時）

* ticker
* スキップ理由（reason_code 相当）
* どのStepで落ちたか（step名）

---

## 7. 非目標（明示）

* “必ずYES候補を出す”ことは目標にしない
  （データ不良の日は全NOでも良い）
* ML/LLMの稼働率を最優先しない
  （落ちたら縮退して継続する）

---

## 8. 最小まとめ（実装者向け）

* 止めるのは「入力契約が壊れたとき」だけ
* 銘柄の問題は銘柄で止める
* 迷ったら NO（またはYES_HALF）
* LLMは最後、落としてよい
* 保守化は一貫して「弱める・減らす・絞る」
