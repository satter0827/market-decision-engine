# repo_index.yml
# このファイルは、ChatGPT 等がリポジトリを素早くナビゲートするための索引です。
# 実装が進んだら、各モジュールの責務・入出力・依存制約を更新してください。

repo:
  name: market-decision-engine
  purpose: "EOD（日次）で投資判断支援の Decision Pack（DecisionCore + ShortSummary）を生成する。最終判断は人間。"
  status: "design-first (code not yet implemented)"
  python: ">=3.11"

invariants:
  - "Deterministic: same input => same output"
  - "LLM is translator/auditor only; must not generate or modify numeric trading parameters"
  - "One-way EOD pipeline (no feedback loop / self-update)"
  - "Fail-safe: when unsure, degrade to NO/YES_HALF or skip"
  - "Feature separation: daily vs static vs fundamental must not be mixed for price calculations"

root_files:
  - path: README.md
    role: "プロジェクト概要・設計原則・Decision Pack 概要"
  - path: pyproject.toml
    role: "パッケージ設定（現状は雛形/未実装の可能性）"
  - path: LICENSE
    role: "ライセンス"

documents:
  - path: documents/000_*
    role: "ドキュメント一覧（どれを何のために固定するか）"
  - path: documents/001_*
    role: "実装規約（Python/CI/Pydantic/依存方向/LLM制約）"
  - path: documents/002_*
    role: "スケジュール（段階リリース M1→M9 など）"
  - path: documents/010_*
    role: "要件定義（MUST/MUST NOT、成功条件、非機能要件）"
  - path: documents/020_*
    role: "外部設計（入出力、運用フロー、保証、縮退の概要）"
  - path: documents/030_*
    role: "内部設計（アーキテクチャ、責務、依存方向、拡張ポイント）"
  - path: documents/031_*
    role: "推奨ディレクトリ構成（将来の src/ 構造の青写真）"
  - path: documents/040_*
    role: "パイプライン設計（EOD step と入出力、エラー時の扱い）"
  - path: documents/050_*
    role: "データ設計（asof/TZ、取得範囲、欠損方針、品質ルール）"
  - path: documents/060_*
    role: "フェイルセーフ（スキップ/停止条件、warnings 方針、縮退）"
  - path: documents/070_*
    role: "用語集（ラベル・語彙の固定、表記揺れ防止）"
  - path: documents/080_ADR.md
    role: "ADR（なぜそうしたか、設計判断の根拠）"

planned_src_layout:
  description: "documents/031 に定義された推奨構成（将来実装時の参照）"
  package_root: "src/market_decision_engine/"
  modules:
    cli:
      responsibility: "CLIエントリポイント（将来API化で差し替え）"
      depends_on: ["pipeline"]
    config:
      responsibility: "設定ロード/デフォルト合成（検証は schemas）"
      depends_on: ["schemas"]
    schemas:
      responsibility: "Contract-first: 外部I/Fと内部境界を Pydantic で固定"
      depends_on: []
      notes:
        - "extra=forbid, frozen=True を原則"
    universe:
      responsibility: "市場別ユニバースとフィルタ（daily根拠を侵食しない）"
      depends_on: ["schemas"]
    data:
      responsibility: "外部データ取得（yfinance）と最低限の前処理"
      depends_on: ["schemas"]
    features:
      responsibility: "特徴量生成（daily/static/fundamental を物理分離）"
      depends_on: ["schemas", "data"]
      constraints:
        - "daily: 候補抽出と execution の主根拠"
        - "static: risk補正/可否のみ"
        - "fundamental: ML評価に段階導入（欠損前提）"
    regime:
      responsibility: "市場環境判定（保守化根拠、価格計算には混ぜない）"
      depends_on: ["schemas", "features"]
    selection:
      responsibility: "候補抽出（dailyのみで完結）"
      depends_on: ["schemas", "features.daily"]
      constraints:
        - "must not depend on llm"
    plans:
      responsibility: "取引プラン（戦略）をカタログ駆動で差し替え可能に"
      depends_on: ["schemas", "features.daily"]
    execution:
      responsibility: "発注可能数値（Entry/Stop/Target/Size）を決定論で生成"
      depends_on: ["schemas", "features.daily", "plans"]
      constraints:
        - "must not import features.static or features.fundamental"
    risk:
      responsibility: "補正・制約（価格は変えず、可否/サイズのみ安全側へ）"
      depends_on: ["schemas", "features.static", "regime"]
    models:
      responsibility: "ML評価（p_success/ev_r/uncertainty）— 任意・縮退可能"
      depends_on: ["schemas", "features.fundamental", "features.daily"]
    decision:
      responsibility: "最終判断（YES/YES_HALF/NO）、rank確定、plan比較"
      depends_on: ["schemas", "execution", "risk", "models?"]
    llm:
      responsibility: "翻訳・監査（ShortSummary生成 / フォーマット強制）"
      depends_on: ["schemas", "reports"]
      constraints:
        - "must not modify DecisionCore"
    reports:
      responsibility: "出力整形（Coreを守り、表現変更で結果を変えない）"
      depends_on: ["schemas"]
    pipeline:
      responsibility: "EOD一方向オーケストレーション（Step順序・縮退適用）"
      depends_on: ["all domain modules"]
    utils:
      responsibility: "共通ユーティリティ（標準名衝突回避）"
      depends_on: []
    exceptions:
      responsibility: "共通例外（Fatal/Degraded/Skip）"
      depends_on: []

prompt_assets:
  - path: PROJECT_CONTEXT.md
    role: "支援ツールに渡す最小コンテキスト（憲法）"
  - path: repo_index.yml
    role: "リポジトリ索引（ナビゲーション）"
